<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quiz Tonalità Musicali</title>
    <link rel="icon" type="image/svg+xml" href="logo.svg">
    <link rel="alternate icon" href="logo.svg">

    <link rel="apple-touch-icon" href="logo.svg">

    <link rel="mask-icon" href="logo.svg" color="#4f46e5">

<meta name="theme-color" content="#f8fafc">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1)',
                    }
                }
            }
        }
    </script>

    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Correzione: Aggiunti prefissi webkit per compatibilità mobile */
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; -webkit-transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        html, body, #root { 
            height: 100%; 
            margin: 0; 
            padding: 0;
            overflow-x: hidden;
            background-color: #f8fafc; 
        }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- HELPER PER ICONE LUCIDE ---
        const createLucideIcon = (name) => {
            const iconData = lucide.icons[name];
            if (!iconData) return (props) => <div {...props}>?</div>;
            return (props) => (
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width={props.size || 24}
                    height={props.size || 24}
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    strokeWidth={props.strokeWidth || 2}
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    className={props.className}
                    {...props}
                >
                    {iconData.map((data, index) => React.createElement(data[0], { key: index, ...data[1] }))}
                </svg>
            );
        };

        const RefreshCw = createLucideIcon('RefreshCw');
        const CheckCircle = createLucideIcon('CheckCircle');
        const XCircle = createLucideIcon('XCircle');
        const Music = createLucideIcon('Music');
        const Hash = createLucideIcon('Hash');
        const Zap = createLucideIcon('Zap');
        const ArrowRight = createLucideIcon('ArrowRight');
        const RotateCcw = createLucideIcon('RotateCcw');

        // --- ICONA BEMOLLE CUSTOM ---
        const FlatIcon = ({ size = 24, className, strokeWidth = 2.5 }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth={strokeWidth} 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
            >
                <path d="M8 4v14" />
                <path d="M8 12c0 0 1.5 2 4.5 2s4.5-2.5 4.5-4.5c0-2.5-2.5-4-4.5-4h-4" />
            </svg>
        );

        // --- DATI DELLE TONALITÀ ---
        const keysData = [
          { id: 1, name: "Do Maggiore", subName: "(C)", alterationCount: 0, alterationsList: "Nessuna", isSharp: null, notesIndices: [0, 2, 4, 5, 7, 9, 11], tonicIndex: 0, color: "#64748b", textColor: "text-slate-600" },
          { id: 2, name: "Sol Maggiore", subName: "(G)", alterationCount: 1, alterationsList: "Fa#", isSharp: true, notesIndices: [7, 9, 11, 0, 2, 4, 6], tonicIndex: 7, color: "#ef4444", textColor: "text-red-600" },
          { id: 3, name: "Re Maggiore", subName: "(D)", alterationCount: 2, alterationsList: "Fa#, Do#", isSharp: true, notesIndices: [2, 4, 6, 7, 9, 11, 1], tonicIndex: 2, color: "#f97316", textColor: "text-orange-600" },
          { id: 4, name: "La Maggiore", subName: "(A)", alterationCount: 3, alterationsList: "Fa#, Do#, Sol#", isSharp: true, notesIndices: [9, 11, 1, 2, 4, 6, 8], tonicIndex: 9, color: "#eab308", textColor: "text-yellow-600" },
          { id: 5, name: "Mi Maggiore", subName: "(E)", alterationCount: 4, alterationsList: "Fa#, Do#, Sol#, Re#", isSharp: true, notesIndices: [4, 6, 8, 9, 11, 1, 3], tonicIndex: 4, color: "#84cc16", textColor: "text-lime-600" },
          { id: 6, name: "Si Maggiore", subName: "(B)", alterationCount: 5, alterationsList: "Fa#, Do#, Sol#, Re#, La#", isSharp: true, notesIndices: [11, 1, 3, 4, 6, 8, 10], tonicIndex: 11, color: "#22c55e", textColor: "text-green-600" },
          { id: 7, name: "Fa# Maggiore", subName: "(F#)", alterationCount: 6, alterationsList: "Fa#, Do#, Sol#, Re#, La#, Mi#", isSharp: true, notesIndices: [6, 8, 10, 11, 1, 3, 5], tonicIndex: 6, color: "#0ea5e9", textColor: "text-sky-600" },
          { id: 8, name: "Do# Maggiore", subName: "(C#)", alterationCount: 7, alterationsList: "Fa#, Do#, Sol#, Re#, La#, Mi#, Si#", isSharp: true, notesIndices: [1, 3, 5, 6, 8, 10, 0], tonicIndex: 1, color: "#3b82f6", textColor: "text-blue-600" },
          { id: 9, name: "Fa Maggiore", subName: "(F)", alterationCount: 1, alterationsList: "Si♭", isSharp: false, notesIndices: [5, 7, 9, 10, 0, 2, 4], tonicIndex: 5, color: "#a855f7", textColor: "text-purple-600" },
          { id: 10, name: "Si♭ Maggiore", subName: "(B♭)", alterationCount: 2, alterationsList: "Si♭, Mi♭", isSharp: false, notesIndices: [10, 0, 2, 3, 5, 7, 9], tonicIndex: 10, color: "#d946ef", textColor: "text-fuchsia-600" },
          { id: 11, name: "Mi♭ Maggiore", subName: "(E♭)", alterationCount: 3, alterationsList: "Si♭, Mi♭, La♭", isSharp: false, notesIndices: [3, 5, 7, 8, 10, 0, 2], tonicIndex: 3, color: "#ec4899", textColor: "text-pink-600" },
          { id: 12, name: "La♭ Maggiore", subName: "(A♭)", alterationCount: 4, alterationsList: "Si♭, Mi♭, La♭, Re♭", isSharp: false, notesIndices: [8, 10, 0, 1, 3, 5, 7], tonicIndex: 8, color: "#f43f5e", textColor: "text-rose-600" },
          { id: 13, name: "Re♭ Maggiore", subName: "(D♭)", alterationCount: 5, alterationsList: "Si♭, Mi♭, La♭, Re♭, Sol♭", isSharp: false, notesIndices: [1, 3, 5, 6, 8, 10, 0], tonicIndex: 1, color: "#14b8a6", textColor: "text-teal-600" },
          { id: 14, name: "Sol♭ Maggiore", subName: "(G♭)", alterationCount: 6, alterationsList: "Si♭, Mi♭, La♭, Re♭, Sol♭, Do♭", isSharp: false, notesIndices: [6, 8, 10, 11, 1, 3, 5], tonicIndex: 6, color: "#10b981", textColor: "text-emerald-600" },
          { id: 15, name: "Do♭ Maggiore", subName: "(C♭)", alterationCount: 7, alterationsList: "Si♭, Mi♭, La♭, Re♭, Sol♭, Do♭, Fa♭", isSharp: false, notesIndices: [11, 1, 3, 4, 6, 8, 10], tonicIndex: 11, color: "#6366f1", textColor: "text-indigo-600" }
        ];

        // --- COMPONENTI ---

        const PianoKeyboard = ({ activeNotes, dotColor, tonicIndex }) => {
          const whiteKeys = [0, 2, 4, 5, 7, 9, 11];
          const blackKeys = [1, 3, 6, 8, 10];
          const whiteKeyIndexMap = {0:0, 2:1, 4:2, 5:3, 7:4, 9:5, 11:6};
          const wH = 100; const wW = 40; const keyWidth = 40; const octaveWidth = keyWidth * 7; 
          let tonicXOffset = 0;
          if (whiteKeyIndexMap.hasOwnProperty(tonicIndex)) {
            tonicXOffset = whiteKeyIndexMap[tonicIndex] * keyWidth;
          } else {
            const xPosMap = {1: 28, 3: 68, 6: 148, 8: 188, 10: 228}; 
            tonicXOffset = xPosMap[tonicIndex];
          }
          const padding = 0.5 * keyWidth; const viewBoxStart = tonicXOffset - padding; const viewBoxWidth = 320; 
          const drawOctave = (offsetX) => {
            const elements = [];
            whiteKeys.forEach((note, index) => {
              const x = offsetX + index * wW;
              let isScaleNote = activeNotes.includes(note);
              let shouldDrawDot = false;
              if (isScaleNote) {
                  if (note >= tonicIndex) { if (offsetX === 0) shouldDrawDot = true; } 
                  else { if (offsetX === octaveWidth) shouldDrawDot = true; }
              }
              elements.push(
                <g key={`w-${note}-${offsetX}`}>
                  <rect x={x} y={0} width={wW} height={wH} fill="white" stroke="#e2e8f0" strokeWidth="1" className="transition-all" />
                  {shouldDrawDot && <circle cx={x + wW/2} cy={wH - 15} r={6} fill={dotColor} />}
                </g>
              );
            });
            const bW = 24; const bH = 65;
            blackKeys.forEach((note) => {
              const xPosMap = {1: 28, 3: 68, 6: 148, 8: 188, 10: 228}; 
              const x = offsetX + xPosMap[note];
              let isScaleNote = activeNotes.includes(note);
              let shouldDrawDot = false;
              if (isScaleNote) {
                  if (note >= tonicIndex) { if (offsetX === 0) shouldDrawDot = true; } 
                  else { if (offsetX === octaveWidth) shouldDrawDot = true; }
              }
              elements.push(
                <g key={`b-${note}-${offsetX}`}>
                  <rect x={x} y={0} width={bW} height={bH} fill="#1e293b" stroke="#0f172a" className="transition-all" />
                  {shouldDrawDot && <circle cx={x + bW/2} cy={bH - 12} r={5} fill={dotColor} stroke="white" strokeWidth={2} />}
                </g>
              );
            });
            return elements;
          };
          return (
            <div className="flex justify-center mt-2 overflow-hidden rounded-lg bg-white">
              <svg width="100%" height={wH} viewBox={`${viewBoxStart} 0 ${viewBoxWidth} ${wH}`} preserveAspectRatio="xMinYMin meet" className="max-w-full">
                {drawOctave(-octaveWidth)} {drawOctave(0)} {drawOctave(octaveWidth)}
              </svg>
            </div>
          );
        };

        const QuizSelection = ({ setMode }) => (
            <div className="flex flex-col items-center justify-center p-6 space-y-5 bg-white rounded-3xl shadow-card w-full max-w-md h-auto min-h-[400px] border border-slate-100">
                <button onClick={() => setMode('sharps')} className="group relative w-full py-6 px-6 bg-gradient-to-br from-red-500 to-red-600 text-white rounded-2xl shadow-lg hover:shadow-red-200 transform transition-all duration-200 hover:scale-[1.02] hover:from-red-600 hover:to-red-700 active:scale-[.98]">
                    <div className="flex items-center justify-between">
                        <div className="flex items-center gap-5">
                            <div className="p-3 bg-white/20 rounded-xl backdrop-blur-sm"><Hash size={32} /></div>
                            <div className="text-left"><span className="block text-3xl font-bold tracking-tight leading-none">Diesis</span></div>
                        </div>
                        <ArrowRight className="opacity-60 group-hover:opacity-100 group-hover:translate-x-1 transition-all" />
                    </div>
                </button>
                <button onClick={() => setMode('flats')} className="group relative w-full py-6 px-6 bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-2xl shadow-lg hover:shadow-blue-200 transform transition-all duration-200 hover:scale-[1.02] hover:from-blue-600 hover:to-blue-700 active:scale-[.98]">
                    <div className="flex items-center justify-between">
                        <div className="flex items-center gap-5">
                            <div className="w-[56px] h-[56px] flex items-center justify-center bg-white/20 rounded-xl backdrop-blur-sm">
                                <span className="text-4xl font-medium leading-none translate-y-1">♭</span>
                            </div>
                            <div className="text-left"><span className="block text-3xl font-bold tracking-tight leading-none">Bemolle</span></div>
                        </div>
                        <ArrowRight className="opacity-60 group-hover:opacity-100 group-hover:translate-x-1 transition-all" />
                    </div>
                </button>
                <button onClick={() => setMode('mix')} className="group relative w-full py-6 px-6 bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-2xl shadow-lg hover:shadow-purple-200 transform transition-all duration-200 hover:scale-[1.02] hover:from-purple-600 hover:to-purple-700 active:scale-[.98]">
                    <div className="flex items-center justify-between">
                        <div className="flex items-center gap-5">
                            <div className="p-3 bg-white/20 rounded-xl backdrop-blur-sm"><Zap size={32} /></div>
                            <div className="text-left"><span className="block text-3xl font-bold tracking-tight leading-none">Tutte le tonalità</span></div>
                        </div>
                        <ArrowRight className="opacity-60 group-hover:opacity-100 group-hover:translate-x-1 transition-all" />
                    </div>
                </button>
            </div>
        );

        const KeySignatureQuiz = () => {
          const [quizMode, setQuizMode] = useState('select'); 
          const [currentKey, setCurrentKey] = useState(null);
          const [isFlipped, setIsFlipped] = useState(false);
          const [userGuess, setUserGuess] = useState('');
          const [feedback, setFeedback] = useState(null);

          const filteredKeys = useMemo(() => {
            if (quizMode === 'sharps') return keysData.filter(key => key.isSharp === true);
            if (quizMode === 'flats') return keysData.filter(key => key.isSharp === false);
            if (quizMode === 'mix') return keysData;
            return [];
          }, [quizMode]);

          const selectRandomKey = () => {
            if (filteredKeys.length === 0) return;
            const randomIndex = Math.floor(Math.random() * filteredKeys.length);
            setCurrentKey(filteredKeys[randomIndex]);
            // Non resettiamo feedback/guess qui, lo facciamo quando l'utente torna alla domanda
            // Ma per il nextQuestion, viene gestito dopo
            setUserGuess('');
            setFeedback(null);
          };

          useEffect(() => {
            if (quizMode !== 'select' && filteredKeys.length > 0) {
              const randomIndex = Math.floor(Math.random() * filteredKeys.length);
              setCurrentKey(filteredKeys[randomIndex]);
              setIsFlipped(false);
              setUserGuess('');
              setFeedback(null);
            }
          }, [quizMode, filteredKeys.length]); 

          const handleGuessChange = (e) => {
            const value = e.target.value.replace(/[^0-7]/g, '');
            setUserGuess(value);
            if (feedback !== null) setFeedback(null);
          };

          const checkAnswer = (e) => {
            e.preventDefault();
            if (userGuess === '' || isFlipped) return;
            const correct = parseInt(userGuess, 10) === currentKey.alterationCount;
            setFeedback(correct ? 'correct' : 'incorrect');
            setTimeout(() => { setIsFlipped(true); }, 500); 
          };

          const nextQuestion = () => { 
            setIsFlipped(false); 
            setTimeout(() => { selectRandomKey(); }, 250); 
          };

          const backToMenu = () => {
              setQuizMode('select');
              setIsFlipped(false); // Reset stato flip quando si torna al menu
          };

          if (quizMode === 'select') {
              return (
                  <div className="flex flex-col items-center justify-center min-h-screen bg-slate-50 p-4 font-sans">
                      <div className="mb-8 text-center animate-fade-in-down">
                          <h1 className="text-3xl font-bold text-slate-800 flex items-center justify-center gap-2 mb-2">
                              <Music className="w-8 h-8 text-indigo-500" />
                              Quiz Tonalità
                          </h1>
                          <p className="text-slate-500">Mettiti alla prova</p>
                      </div>
                      <QuizSelection setMode={setQuizMode} />
                  </div>
              );
          }

          if (!currentKey) return <div className="text-center p-8">Caricamento...</div>;

          let alterationType, headerText;
          if (quizMode === 'sharps') { alterationType = "diesis"; headerText = "Diesis (#)"; } 
          else if (quizMode === 'flats') { alterationType = "bemolle"; headerText = <span>Bemolle (♭)</span>; } 
          else { alterationType = "alterazioni"; headerText = "Tutte le Tonalità"; }
          
          const promptText = (quizMode === 'mix' && currentKey.alterationCount === 0) 
              ? "Inserisci il numero di alterazioni"
              : <span>Numero di {alterationType}?</span>;

          return (
            <div className="flex flex-col items-center justify-center min-h-screen bg-slate-50 p-4 font-sans">
              <div className="mb-6 text-center">
                <div className="inline-flex items-center justify-center px-4 py-1.5 rounded-full bg-white border border-slate-200 shadow-sm text-sm font-medium text-slate-500 mb-2">
                    {headerText}
                </div>
                <h2 className="text-lg text-slate-400 font-medium">{promptText}</h2>
              </div>

              <div className="relative w-full max-w-sm h-[480px] perspective-1000 group">
                <div className={`relative w-full h-full duration-500 transform-style-3d transition-transform ${isFlipped ? 'rotate-y-180' : ''}`}>
                  
                  {/* FRONT */}
                  <div 
                    className="absolute w-full h-full bg-white rounded-3xl shadow-card backface-hidden flex flex-col items-center border-2 border-slate-100 overflow-hidden"
                    style={{ zIndex: isFlipped ? 0 : 10 }} 
                  >
                    <div className="w-full h-3" style={{ backgroundColor: currentKey.color }}></div>
                    <div className="flex-1 flex flex-col items-center justify-center w-full p-8 space-y-8">
                        <div className="text-center space-y-2">
                            <span className="text-xs font-bold tracking-widest text-slate-300 uppercase">Tonalità</span>
                            <h2 className="text-4xl font-black text-slate-800 tracking-tight leading-none">{currentKey.name}</h2>
                            <p className="text-2xl font-medium text-slate-400">{currentKey.subName}</p>
                        </div>
                        <form onSubmit={checkAnswer} className="w-full flex flex-col items-center space-y-6">
                            <div className="relative flex items-center justify-center">
                                <input type="tel" value={userGuess} onChange={handleGuessChange} maxLength="1" min="0" max="7" disabled={isFlipped} className="w-24 h-24 text-6xl font-bold text-center bg-slate-50 border-2 border-slate-200 rounded-2xl focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20 outline-none transition-all text-slate-700 placeholder-slate-200 shadow-inner" placeholder="?" autoFocus />
                                {feedback === 'correct' && !isFlipped && <div className="absolute -right-12 top-1/2 -translate-y-1/2"><CheckCircle className="w-8 h-8 text-emerald-500 drop-shadow-sm animate-bounce" strokeWidth={3} /></div>}
                                {feedback === 'incorrect' && !isFlipped && <div className="absolute -right-12 top-1/2 -translate-y-1/2"><XCircle className="w-8 h-8 text-red-500 drop-shadow-sm animate-shake" strokeWidth={3} /></div>}
                            </div>
                            <button type="submit" disabled={isFlipped || userGuess === ''} className="w-full py-4 bg-gradient-to-r from-indigo-600 to-indigo-500 text-white font-bold text-lg rounded-2xl shadow-lg hover:shadow-indigo-200 hover:scale-[1.02] active:scale-[.98] transition-all disabled:opacity-50 disabled:shadow-none disabled:scale-100 hover:from-indigo-700 hover:to-indigo-600">Verifica</button>
                        </form>
                    </div>
                    <button type="button" onClick={backToMenu} className="w-full py-4 bg-slate-50 text-slate-400 text-sm font-medium hover:text-slate-600 transition-colors border-t border-slate-100 flex items-center justify-center gap-2"><RotateCcw size={14} /> Torna al Menù</button>
                  </div>

                  {/* BACK */}
                  <div 
                    className="absolute w-full h-full bg-white rounded-3xl shadow-card backface-hidden rotate-y-180 flex flex-col items-center border-2 border-slate-100 overflow-hidden"
                    style={{ zIndex: isFlipped ? 10 : 0 }}
                  >
                    <div className="w-full h-3" style={{ backgroundColor: currentKey.color }}></div>
                    <div className="flex-1 w-full p-6 flex flex-col items-center">
                        <div className="text-center mb-6">
                            <h3 className="text-2xl font-bold text-slate-800">{currentKey.name}</h3>
                            <p className="text-slate-400 font-medium">{currentKey.subName}</p>
                        </div>
                        <div className={`w-full rounded-2xl p-4 mb-4 border ${feedback === 'correct' ? 'bg-emerald-50 border-emerald-100' : 'bg-red-50 border-red-100'}`}>
                            <div className="flex items-center justify-between mb-2">
                                <span className="text-xs font-bold uppercase tracking-wider text-slate-400">Soluzione</span>
                                <span className={`text-sm font-bold ${feedback === 'correct' ? 'text-emerald-600' : 'text-red-600'}`}>{feedback === 'correct' ? 'Corretto!' : 'Errato'}</span>
                            </div>
                            <div className="flex items-end gap-2">
                                <span className="text-4xl font-black text-slate-700 leading-none">{currentKey.alterationCount}</span>
                                <span className="text-sm font-medium text-slate-500 mb-1">{currentKey.alterationsList}</span>
                            </div>
                        </div>
                        <div className="w-full p-3 bg-slate-50 rounded-2xl border border-slate-100 mb-auto">
                           <PianoKeyboard activeNotes={currentKey.notesIndices} dotColor={currentKey.color} tonicIndex={currentKey.tonicIndex} />
                        </div>
                    </div>
                    {/* FOOTER */}
                    <div className="w-full px-6 pb-4">
                        <button onClick={nextQuestion} className={`w-full py-3.5 text-white font-bold rounded-xl shadow-md transition-all active:scale-[.98] flex items-center justify-center gap-2 ${feedback === 'correct' ? 'bg-emerald-500 hover:bg-emerald-600 shadow-emerald-200' : 'bg-blue-500 hover:bg-blue-600 shadow-blue-200'}`}><RefreshCw size={20} /> Prossima</button>
                    </div>
                    {/* Pulsante Torna al Menu Identico al Front */}
                    <button type="button" onClick={backToMenu} className="w-full py-4 bg-slate-50 text-slate-400 text-sm font-medium hover:text-slate-600 transition-colors border-t border-slate-100 flex items-center justify-center gap-2"><RotateCcw size={14} /> Torna al Menù</button>
                  </div>
                </div>
              </div>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<KeySignatureQuiz />);
    </script>
</body>
</html>
